<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Lasso Mask Tool (Hover & Click Remove)</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    #toolbar {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    canvas {
      border: 1px solid #888;
      max-width: 100%;
      cursor: crosshair;
      background: #111;
    }

    #canvasContainer {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .canvasBox {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h3 {
      margin: 6px 0;
    }
  </style>
</head>

<body>
  <h2>üé® Lasso Mask Tool (Hover + Click Remove)</h2>
  <div id="toolbar">
    <input type="file" id="imageLoader" accept="image/*">
    <button id="undoBtn">üîô Undo</button>
    <button id="clearBtn">üóëÔ∏è Clear All</button>
  </div>

  <div id="canvasContainer">
    <div class="canvasBox">
      <h3>Original + Lassos</h3>
      <canvas id="inputCanvas" width="600" height="400"></canvas>
    </div>
    <div class="canvasBox">
      <h3>Mask Output</h3>
      <canvas id="maskCanvas" width="600" height="400"></canvas>
    </div>
  </div>

  <script>
    const inputCanvas = document.getElementById('inputCanvas');
    const maskCanvas = document.getElementById('maskCanvas');
    const ctx = inputCanvas.getContext('2d');
    const mctx = maskCanvas.getContext('2d');

    const imageLoader = document.getElementById('imageLoader');
    const undoBtn = document.getElementById('undoBtn');
    const clearBtn = document.getElementById('clearBtn');

    let image = new Image();
    let lassos = [];
    let currentLasso = [];
    let isDrawing = false;
    let isClickOnly = false;
    let hoverIndex = -1;

    // Load image
    imageLoader.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = event => {
        image.onload = () => {
          inputCanvas.width = maskCanvas.width = image.width;
          inputCanvas.height = maskCanvas.height = image.height;
          redraw();
        };
        image.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });

    // Mouse events
    inputCanvas.addEventListener('mousedown', e => {
      if (!image.src) return;
      isDrawing = true;
      isClickOnly = true;
      currentLasso = [{ x: e.offsetX, y: e.offsetY }];
    });

    inputCanvas.addEventListener('mousemove', e => {
      if (!image.src) return;

      if (isDrawing) {
        // Drawing a new lasso
        isClickOnly = false;
        currentLasso.push({ x: e.offsetX, y: e.offsetY });
        redraw();
        drawLasso(currentLasso, false, 'lime');
      } else {
        // Hovering - check highlight
        hoverIndex = findLassoAtPoint(e.offsetX, e.offsetY);
        redraw();
      }
    });

    inputCanvas.addEventListener('mouseup', e => {
      if (!image.src) return;

      if (isDrawing && !isClickOnly && currentLasso.length > 2) {
        // Add new lasso
        lassos.push([...currentLasso]);
      } else if (isClickOnly) {
        // Click-only ‚Äî remove if inside existing lasso
        const click = { x: e.offsetX, y: e.offsetY };
        const index = findLassoAtPoint(click.x, click.y);
        if (index !== -1) lassos.splice(index, 1);
      }

      isDrawing = false;
      redraw();
    });

    // Undo & Clear
    undoBtn.addEventListener('click', () => {
      lassos.pop();
      redraw();
    });

    clearBtn.addEventListener('click', () => {
      lassos = [];
      redraw();
    });

    // Redraw everything
    function redraw() {
      ctx.clearRect(0, 0, inputCanvas.width, inputCanvas.height);
      if (image.src) ctx.drawImage(image, 0, 0, inputCanvas.width, inputCanvas.height);

      // Draw lassos
      lassos.forEach((lasso, i) => {
        const color = (i === hoverIndex) ? 'yellow' : 'lime';
        drawLasso(lasso, true, color, (i === hoverIndex ? 0.4 : 0.2));
      });

      updateMaskCanvas();
    }

    // Draw a single lasso
    function drawLasso(points, close = true, strokeColor = 'lime', fillAlpha = 0.2) {
      if (points.length < 2) return;
      ctx.beginPath();
      ctx.moveTo(points[0].x, points[0].y);
      for (let i = 1; i < points.length; i++) ctx.lineTo(points[i].x, points[i].y);
      if (close) ctx.closePath();
      ctx.strokeStyle = strokeColor;
      ctx.lineWidth = (strokeColor === 'yellow') ? 2 : 1.2;
      ctx.stroke();
      if (close) {
        ctx.fillStyle = `rgba(255,255,0,${fillAlpha})`;
        if (strokeColor === 'lime') ctx.fillStyle = `rgba(0,255,0,${fillAlpha})`;
        ctx.fill();
      }
    }

    // Draw black-white mask
    function updateMaskCanvas() {
      mctx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
      mctx.fillStyle = 'black';
      mctx.fillRect(0, 0, maskCanvas.width, maskCanvas.height);

      lassos.forEach(lasso => {
        mctx.beginPath();
        mctx.moveTo(lasso[0].x, lasso[0].y);
        for (let i = 1; i < lasso.length; i++) mctx.lineTo(lasso[i].x, lasso[i].y);
        mctx.closePath();
        mctx.fillStyle = 'white';
        mctx.fill();
      });
    }

    // Check if point is inside any lasso
    function findLassoAtPoint(x, y) {
      for (let i = lassos.length - 1; i >= 0; i--) { // topmost first
        ctx.beginPath();
        ctx.moveTo(lassos[i][0].x, lassos[i][0].y);
        for (let j = 1; j < lassos[i].length; j++) ctx.lineTo(lassos[i][j].x, lassos[i][j].y);
        ctx.closePath();
        if (ctx.isPointInPath(x, y)) return i;
      }
      return -1;
    }
  </script>
</body>

</html>